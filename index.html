<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fist Pump Fix</title>
    <style>
        body {
            margin: 0; padding: 0;
            background-color: #111; color: #fff;
            font-family: sans-serif; height: 100vh;
            display: flex; flex-direction: column; justify-content: flex-end;
            transition: background-color 0.1s;
        }
        #controls {
            background: rgba(0,0,0,0.9); padding: 20px;
            border-top: 2px solid #333; z-index: 100;
        }
        button {
            width: 100%; padding: 20px; font-size: 1.2rem;
            background: #00ff88; border: none; border-radius: 10px;
            font-weight: bold; margin-bottom: 10px;
        }
        .debug-box {
            background: #000; color: #0f0; font-family: monospace;
            font-size: 11px; height: 100px; overflow-y: scroll;
            padding: 10px; border: 1px solid #444; margin-top: 10px;
        }
        .stats { display: flex; justify-content: space-between; font-size: 12px; color: #aaa; margin-bottom: 5px;}
    </style>
</head>
<body>

    <div id="controls">
        <div class="stats">
            <span>Force: <b id="force-ui">0</b></span>
            <span>Torch: <b id="torch-ui">WAITING</b></span>
        </div>
        <button id="mainBtn">ACTIVATE SENSORS</button>
        <div id="log" class="debug-box">System ready. Tap button to start.</div>
    </div>

    <script>
        const mainBtn = document.getElementById('mainBtn');
        const logBox = document.getElementById('log');
        const forceUi = document.getElementById('force-ui');
        const torchUi = document.getElementById('torch-ui');
        
        let videoTrack = null;
        let isRunning = false;

        function print(msg) {
            const div = document.createElement('div');
            div.textContent = `> ${msg}`;
            logBox.prepend(div);
        }

        async function startApp() {
            print("Step 1: Requesting Camera...");
            try {
                // Request camera (mandatory for flashlight)
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                videoTrack = stream.getVideoTracks()[0];
                
                const caps = videoTrack.getCapabilities();
                if (caps.torch) {
                    torchUi.innerText = "READY";
                    torchUi.style.color = "#00ff88";
                    print("Flashlight support confirmed.");
                } else {
                    torchUi.innerText = "NO TORCH";
                    print("Camera found, but no flashlight API.");
                }

                print("Step 2: Requesting Motion...");
                // Request Motion (iOS 13+ requirement)
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    const res = await DeviceMotionEvent.requestPermission();
                    print("Motion Permission: " + res);
                } else {
                    print("Standard Motion API detected.");
                }

                window.addEventListener('devicemotion', (e) => {
                    let acc = e.accelerationIncludingGravity || e.acceleration;
                    if (!acc) return;

                    let total = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
                    forceUi.innerText = Math.floor(total);

                    // Threshold trigger (Adjust 25 if too sensitive)
                    if (total > 25) {
                        pulse();
                    }
                });

                isRunning = true;
                mainBtn.innerText = "RESET APP";
                mainBtn.style.background = "#555";
                print("SYSTEM ACTIVE. PUMP PHONE.");

            } catch (err) {
                print("FATAL ERROR: " + err.name);
                console.error(err);
            }
        }

        async function pulse() {
            // Flash screen random color
            document.body.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`;
            
            // Try flashlight
            if (videoTrack && videoTrack.getCapabilities().torch) {
                try {
                    await videoTrack.applyConstraints({ advanced: [{ torch: true }] });
                    setTimeout(() => videoTrack.applyConstraints({ advanced: [{ torch: false }] }), 50);
                } catch (e) {}
            }

            setTimeout(() => {
                document.body.style.backgroundColor = '#111';
            }, 100);
        }

        mainBtn.addEventListener('click', () => {
            if (!isRunning) startApp();
            else location.reload();
        });
    </script>
</body>
</html>
