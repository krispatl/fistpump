<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fist Pump Debugger</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            font-family: monospace;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.05s ease-out;
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* Moves everything to bottom */
        }

        #ui-layer {
            background: rgba(20, 20, 20, 0.9);
            border-top: 1px solid #444;
            padding: 15px;
            padding-bottom: env(safe-area-inset-bottom); /* iOS Notch support */
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        #debug-console {
            font-size: 10px;
            color: #0f0;
            height: 80px;
            overflow-y: auto;
            background: #111;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #333;
        }

        button {
            flex: 1;
            padding: 12px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            background: #00ff88;
            color: #000;
        }

        input[type=range] { flex: 2; }
        
        .stat-label { color: #888; font-size: 10px; text-transform: uppercase; }
        .val { color: #fff; font-weight: bold; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="debug-console">Initializing... Waiting for user interaction.</div>
        
        <div class="row">
            <div id="accel-data">
                <span class="stat-label">Force:</span> <span id="mag-val" class="val">0.0</span>
            </div>
            <div id="torch-status">
                <span class="stat-label">Torch:</span> <span id="torch-val" class="val">OFF</span>
            </div>
        </div>

        <div class="row">
            <span class="stat-label">Sensitivity</span>
            <input type="range" id="threshold" min="5" max="60" value="20">
            <span id="thresh-display" class="val">20</span>
        </div>

        <div class="row">
            <button id="startBtn">ACTIVATE PARTY MODE</button>
        </div>
    </div>

    <script>
        const startBtn = document.getElementById('startBtn');
        const debug = document.getElementById('debug-console');
        const magVal = document.getElementById('mag-val');
        const torchVal = document.getElementById('torch-val');
        const thresholdInput = document.getElementById('threshold');
        const threshDisplay = document.getElementById('thresh-display');

        let track = null;
        let isActive = false;
        let lastTrigger = 0;

        function log(msg) {
            const time = new Date().toLocaleTimeString().split(' ')[0];
            debug.innerHTML = `[${time}] ${msg}<br>` + debug.innerHTML;
        }

        thresholdInput.oninput = () => threshDisplay.innerText = thresholdInput.value;

        async function init() {
            log("Requesting permissions...");
            try {
                // 1. Camera Access
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                track = stream.getVideoTracks()[0];
                
                // Inspect Capabilities
                const caps = track.getCapabilities();
                if (caps.torch) {
                    log("Flashlight hardware detected!");
                    torchVal.innerText = "READY";
                    torchVal.style.color = "#00ff88";
                } else {
                    log("Flashlight NOT detected by browser.");
                    torchVal.innerText = "UNSUPPORTED";
                    torchVal.style.color = "#ff4444";
                }

                // 2. Motion Access (iOS)
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    const permission = await DeviceMotionEvent.requestPermission();
                    log("Motion Permission: " + permission);
                }

                window.addEventListener('devicemotion', handleMotion);
                isActive = true;
                startBtn.innerText = "SHUTDOWN";
                startBtn.style.background = "#ff4444";
                log("System Active. Pump it!");

            } catch (err) {
                log("Error: " + err.message);
            }
        }

        function handleMotion(event) {
            const acc = event.accelerationIncludingGravity;
            if (!acc) return;

            const magnitude = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
            magVal.innerText = magnitude.toFixed(1);

            const limit = parseInt(thresholdInput.value);
            const now = Date.now();

            if (magnitude > limit && now - lastTrigger > 150) {
                triggerPulse();
                lastTrigger = now;
            }
        }

        async function triggerPulse() {
            // Screen Flash
            document.body.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
            
            // Torch Flash
            if (track && track.getCapabilities().torch) {
                try {
                    await track.applyConstraints({ advanced: [{ torch: true }] });
                    setTimeout(() => {
                        track.applyConstraints({ advanced: [{ torch: false }] });
                    }, 60);
                } catch (e) {
                    log("Torch Apply Error: " + e.message);
                }
            }

            setTimeout(() => {
                document.body.style.backgroundColor = '#000';
            }, 100);
        }

        startBtn.addEventListener('click', () => {
            if (!isActive) init();
            else location.reload();
        });
    </script>
</body>
</html>
